rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() { return request.auth != null; }
    function hasPerm(p) {
      return isAuth() && (
        (request.auth.token.permissions != null && p in request.auth.token.permissions) ||
        (request.auth.token.role == 'admin')
      );
    }
    function isAdmin() {
      return isAuth() && (
        request.auth.token.role == 'admin' ||
        (request.auth.token.permissions != null && 'admin' in request.auth.token.permissions) ||
        request.auth.token.email == 'admin@carniceria.com'
      );
    }

    // Productos
    match /products/{id} {
      allow read: if isAuth();
      allow create, update, delete: if hasPerm('products') || isAdmin();
    }

    // Ventas
    match /sales/{id} {
      allow read: if isAuth();
      allow create: if hasPerm('sales') || isAdmin();
      allow update: if (hasPerm('sales') || isAdmin()) && resource.data.createdByUid == request.auth.uid;
      allow delete: if isAdmin();
    }
    match /sales/{saleId}/items/{itemId} {
      allow read: if isAuth();
      allow write: if hasPerm('sales') || isAdmin();
    }

    // Inventario
    match /inventory/{id} {
      allow read: if isAuth();
      allow create, update, delete: if hasPerm('inventory') || hasPerm('sales') || isAdmin();
    }

    // Movimientos de inventario
    match /inventory_movements/{id} {
      allow read: if isAuth();
      allow create: if hasPerm('inventory') || isAdmin();
      allow update, delete: if isAdmin();
    }

    // Clientes
    match /customers/{id} {
      allow read: if isAuth();
      allow create, update, delete: if hasPerm('customers') || isAdmin();
    }

    // Empleados
    match /employees/{id} {
      allow read: if hasPerm('employees') || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Proveedores
    match /suppliers/{id} {
      allow read: if isAuth();
      allow create, update, delete: if hasPerm('suppliers') || isAdmin();
    }

    // Categor√≠as
    match /categories/{id} {
      allow read: if isAuth();
      allow create, update, delete: if hasPerm('products') || isAdmin();
    }

    // Turnos
    match /shifts/{id} {
      allow read: if isAuth();
      allow create: if hasPerm('sales') || isAdmin();
      allow update: if hasPerm('sales') || isAdmin();
      allow delete: if isAdmin();
    }

    // Arqueos de caja
    match /cash_counts/{id} {
      allow read: if isAuth();
      allow create: if hasPerm('sales') || isAdmin();
      allow update: if hasPerm('sales') || isAdmin();
      allow delete: if isAdmin();
    }

    // Gastos
    match /expenses/{id} {
      allow read: if hasPerm('expenses') || isAdmin();
      allow create: if hasPerm('expenses') || isAdmin();
      allow update: if (hasPerm('expenses') || isAdmin()) && resource.data.createdByUid == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Compras
    match /purchases/{id} {
      allow read: if hasPerm('purchases') || isAdmin();
      allow create: if hasPerm('purchases') || isAdmin();
      allow update, delete: if isAdmin();
    }

    // Notificaciones y actividad
    match /notifications/{id} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAdmin();
    }
    match /activity_logs/{id} {
      allow read: if isAdmin();
      allow create: if isAuth();
      allow update, delete: if isAdmin();
    }
  }
}

// trigger: no-op change to deploy rules via GitHub Actions